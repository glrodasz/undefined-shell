---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Container from "../components/Container.astro";
import SimpleAnalytics from "../components/SimpleAnalytics.astro";
import LanguageVersionBanner from "../components/LanguageVersionBanner.astro";
import { type Locale, getLocaleFromAstro } from "../i18n/config";
import { getMessages } from "../i18n";

type LanguageVersion = {
  language: string;
  url: string;
};

type Props = CollectionEntry<"posts">["data"] & {
  readingTime?: number;
  locale?: Locale;
  languageVersions?: LanguageVersion[];
};

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  readingTime,
  languageVersions,
} = Astro.props;

const locale = getLocaleFromAstro(Astro);
const messages = getMessages(locale);
const tabTitle = `${title} • ${messages.site.description} • ${messages.site.title} by ${messages.site.author}`;
---

<html lang={locale}>
  <head>
    <BaseHead
      title={title}
      tabTitle={tabTitle}
      description={description}
      image={heroImage}
    />
    <style>
      .hero-image {
        width: 100%;
        margin-bottom: 1em;
      }
      .hero-image img {
        display: block;
        margin: 0 auto;
        aspect-ratio: 48 / 9;
        object-fit: cover;
        width: 100%;
      }
      .prose {
        max-width: 920px;
        width: 100%;
        margin: auto;
        color: var(--color-black-pearl-700);
      }
      .title {
        padding: 1em 0 0;
        text-align: left;
        line-height: 1;
      }
      .title h1 {
        margin: 3rem 0 2rem;
        color: var(--color-black-pearl-900);
      }
      .date,
      .reading-time {
        color: rgb(var(--gray));
      }

      .subheader {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }

      .has-hero-image {
        padding-top: 0;
      }

      @media (max-width: 920px) {
        .hero-image img {
          aspect-ratio: 24 / 9;
        }

        .date {
          display: flex;
          flex-direction: column;
        }
      }
    </style>
  </head>

  <body>
    <Header locale={locale} />
    <div class="hero-image">
      {heroImage && <img width={1200} height={510} src={heroImage} alt="" />}
    </div>
    <Container>
      <main class={heroImage ? "has-hero-image" : ""}>
        <article>
          <div class="prose">
            <div class="title">
              <div class="subheader">
                <div class="date">
                  <FormattedDate
                    date={pubDate}
                    leadingComma={Boolean(updatedDate)}
                    locale={locale}
                  />
                  {
                    updatedDate && (
                      <span class="last-updated-on">
                        {messages.blog.lastUpdatedOn}{" "}
                        <FormattedDate date={updatedDate} locale={locale} />
                      </span>
                    )
                  }
                </div>
                {
                  readingTime && (
                    <strong class="reading-time">
                      ⏱️ {readingTime} {messages.blog.minRead}
                    </strong>
                  )
                }
              </div>
              <h1>{title}</h1>
            </div>
            <LanguageVersionBanner
              languageVersions={languageVersions}
              currentLocale={locale}
            />
            <div class="blog-content">
              <slot />
            </div>
          </div>
        </article>
      </main>
    </Container>
    <Footer locale={locale} />
    <SimpleAnalytics />
    <script>
      const headings = Array.from(
        document.querySelectorAll(
          ".blog-content h2[id], .blog-content h3[id], .blog-content h4[id], .blog-content h5[id], .blog-content h6[id]"
        )
      );

      const copyLinkToClipboard = async (url: string) => {
        if (navigator.clipboard?.writeText) {
          try {
            await navigator.clipboard.writeText(url);
            return true;
          } catch (error) {
            console.warn("Clipboard write failed, falling back to execCommand.", error);
          }
        }

        const helper = document.createElement("textarea");
        helper.value = url;
        helper.setAttribute("readonly", "");
        helper.style.position = "absolute";
        helper.style.left = "-9999px";
        document.body.appendChild(helper);
        helper.select();
        const copied = document.execCommand("copy");
        document.body.removeChild(helper);
        return copied;
      };

      const handleCopy = (heading: HTMLHeadingElement) => {
        const id = heading.id;
        if (!id) return;
        const url = `${window.location.origin}${window.location.pathname}#${id}`;

        window.history.replaceState(null, "", `#${id}`);
        copyLinkToClipboard(url);
        heading.classList.add("copied");
        window.setTimeout(() => heading.classList.remove("copied"), 1500);
      };

      headings.forEach((heading) => {
        if (!(heading instanceof HTMLHeadingElement)) return;
        if (heading.dataset.shareableHeading === "true" || !heading.id) return;

        const headingText = heading.textContent?.trim() ?? "section";
        heading.dataset.shareableHeading = "true";
        heading.tabIndex = 0;
        heading.classList.add("shareable-heading");

        const linkButton = document.createElement("button");
        linkButton.type = "button";
        linkButton.className = "heading-copy";
        linkButton.setAttribute(
          "aria-label",
          `Copy link to "${headingText}"`
        );
        linkButton.innerHTML = `
          <svg aria-hidden="true" viewBox="0 0 24 24" focusable="false">
            <path
              fill="none"
              stroke="currentColor"
              stroke-width="1.6"
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M10.5 13.5 13 11a3 3 0 1 1 4.24 4.24l-2.5 2.5a3 3 0 0 1-4.24 0M13.5 10.5 11 13a3 3 0 1 1-4.24-4.24l2.5-2.5a3 3 0 0 1 4.24 0"
            />
          </svg>
        `;

        const copyHandler = (event: Event) => {
          event.preventDefault();
          event.stopPropagation();
          handleCopy(heading);
        };

        linkButton.addEventListener("click", copyHandler);
        heading.addEventListener("click", copyHandler);
        heading.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            handleCopy(heading);
          }
        });

        heading.appendChild(linkButton);
      });
    </script>
    <style>
      .blog-content {
        margin-top: 2rem;
      }

      .last-updated-on {
        font-style: italic;
      }

      .blog-content h2.shareable-heading,
      .blog-content h3.shareable-heading,
      .blog-content h4.shareable-heading,
      .blog-content h5.shareable-heading,
      .blog-content h6.shareable-heading {
        position: relative;
        padding-right: 2rem;
      }

      .shareable-heading {
        cursor: pointer;
        scroll-margin-top: 6rem;
      }

      .heading-copy {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        color: var(--color-black-pearl-300);
        padding: 0.25rem;
        border-radius: 6px;
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0;
        transition: opacity 0.2s ease-in-out, color 0.2s ease-in-out,
          background-color 0.2s ease-in-out;
      }

      .shareable-heading:hover .heading-copy,
      .shareable-heading:focus-within .heading-copy,
      .shareable-heading.copied .heading-copy {
        opacity: 1;
      }

      .heading-copy:focus-visible,
      .heading-copy:hover {
        color: var(--accent);
        background-color: rgba(var(--gray), 0.08);
        opacity: 1;
      }

      .heading-copy:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      .shareable-heading.copied .heading-copy {
        color: var(--accent);
      }

      .heading-copy svg {
        width: 1em;
        height: 1em;
        pointer-events: none;
      }
    </style>
  </body>
</html>
