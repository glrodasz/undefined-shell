---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Container from "../components/Container.astro";
import SimpleAnalytics from "../components/SimpleAnalytics.astro";
import LanguageVersionBanner from "../components/LanguageVersionBanner.astro";
import { type Locale, getLocaleFromAstro } from "../i18n/config";
import { getMessages } from "../i18n";
import { Link } from "lucide";

const linkIconPaths = Link;

type LanguageVersion = {
  language: string;
  url: string;
};

type Props = CollectionEntry<"posts">["data"] & {
  readingTime?: number;
  locale?: Locale;
  languageVersions?: LanguageVersion[];
};

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  readingTime,
  languageVersions,
} = Astro.props;

const locale = getLocaleFromAstro(Astro);
const messages = getMessages(locale);
const tabTitle = `${title} • ${messages.site.description} • ${messages.site.title} by ${messages.site.author}`;
---

<html lang={locale}>
  <head>
    <BaseHead
      title={title}
      tabTitle={tabTitle}
      description={description}
      image={heroImage}
    />
    <style>
      .hero-image {
        width: 100%;
        margin-bottom: 1em;
      }
      .hero-image img {
        display: block;
        margin: 0 auto;
        aspect-ratio: 48 / 9;
        object-fit: cover;
        width: 100%;
      }
      .prose {
        max-width: 920px;
        width: 100%;
        margin: auto;
        color: var(--color-black-pearl-700);
      }
      .title {
        padding: 1em 0 0;
        text-align: left;
        line-height: 1;
      }
      .title h1 {
        margin: 3rem 0 2rem;
        color: var(--color-black-pearl-900);
      }
      .date,
      .reading-time {
        color: rgb(var(--gray));
      }

      .subheader {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }

      .has-hero-image {
        padding-top: 0;
      }

      @media (max-width: 920px) {
        .hero-image img {
          aspect-ratio: 24 / 9;
        }

        .date {
          display: flex;
          flex-direction: column;
        }
      }
    </style>
  </head>

  <body>
    <Header locale={locale} />
    <div class="hero-image">
      {heroImage && <img width={1200} height={510} src={heroImage} alt="" />}
    </div>
    <Container>
      <main class={heroImage ? "has-hero-image" : ""}>
        <article>
          <div class="prose">
            <div class="title">
              <div class="subheader">
                <div class="date">
                  <FormattedDate
                    date={pubDate}
                    leadingComma={Boolean(updatedDate)}
                    locale={locale}
                  />
                  {
                    updatedDate && (
                      <span class="last-updated-on">
                        {messages.blog.lastUpdatedOn}{" "}
                        <FormattedDate date={updatedDate} locale={locale} />
                      </span>
                    )
                  }
                </div>
                {
                  readingTime && (
                    <strong class="reading-time">
                      ⏱️ {readingTime} {messages.blog.minRead}
                    </strong>
                  )
                }
              </div>
              <h1>{title}</h1>
            </div>
            <LanguageVersionBanner
              languageVersions={languageVersions}
              currentLocale={locale}
            />
            <div class="blog-content">
              <slot />
            </div>
          </div>
        </article>
      </main>
    </Container>
    <Footer locale={locale} />
    <SimpleAnalytics />
    <script define:vars={{ linkIconPaths: JSON.stringify(linkIconPaths) }}>
      const linkIconData = JSON.parse(linkIconPaths);
      const headings = Array.from(
        document.querySelectorAll(
          ".blog-content h2[id], .blog-content h3[id], .blog-content h4[id], .blog-content h5[id], .blog-content h6[id]"
        )
      );

      const copyLinkToClipboard = async (url) => {
        if (navigator.clipboard?.writeText) {
          try {
            await navigator.clipboard.writeText(url);
            return true;
          } catch (error) {
            console.warn(
              "Clipboard write failed, falling back to execCommand.",
              error
            );
          }
        }

        const helper = document.createElement("textarea");
        helper.value = url;
        helper.setAttribute("readonly", "");
        helper.style.position = "absolute";
        helper.style.left = "-9999px";
        document.body.appendChild(helper);
        helper.select();
        const copied = document.execCommand("copy");
        document.body.removeChild(helper);
        return copied;
      };

      const handleCopy = (heading) => {
        const id = heading.id;
        if (!id) return;
        const url = `${window.location.origin}${window.location.pathname}#${id}`;

        window.history.replaceState(null, "", `#${id}`);
        copyLinkToClipboard(url);
        heading.classList.add("copied");
        window.setTimeout(() => heading.classList.remove("copied"), 1500);
      };

      headings.forEach((heading) => {
        if (!(heading instanceof HTMLHeadingElement)) return;
        if (heading.dataset.shareableHeading === "true" || !heading.id) return;

        const headingText = heading.textContent?.trim() ?? "section";
        heading.dataset.shareableHeading = "true";
        heading.tabIndex = 0;
        heading.classList.add("shareable-heading");

        const linkIcon = document.createElement("span");
        linkIcon.className = "heading-link-icon";
        linkIcon.setAttribute("aria-hidden", "true");
        linkIcon.innerHTML = `
          <svg width="0.6em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            ${linkIconData.map(([_, attrs]) => `<path d="${attrs.d}" />`).join("")}
          </svg>
        `;

        const copyHandler = (event) => {
          event.preventDefault();
          handleCopy(heading);
        };

        heading.addEventListener("click", copyHandler);
        heading.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            handleCopy(heading);
          }
        });

        heading.appendChild(linkIcon);
      });
    </script>
    <style>
      .blog-content {
        margin-top: 2rem;
      }

      .last-updated-on {
        font-style: italic;
      }
    </style>
  </body>
</html>
